<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
  </head>
  <body>
    <h1>Women In Hollywood</h1>
    <h2>What is the Bechdel Test?</h2>
    <p>blah </p>

    <h2>What was your favorite childhood movie?</h2>
    <input></input> 


    <h2>Line Chart</h2>
    <div id="line_chart">
      <!-- This is where we will put our chart. -->
    </div>

    <h2>Bubble Chart</h2>
    <p>Year: 1990 (change this later on)</p>

    <div class="two-col">
        <div id="bubble_chart" style="width:520px;height:420px;">
            <!-- This is where we will put our chart. -->
        </div>
        <div id="bubble_legend" style="width:320px;height:420px;">
            <!-- This is where we will put our chart. -->
        </div>
    </div>
    <style>
        .two-col {
            display: flex;
            flex-direction: row;
        }
    </style>

    <style>
      .selected {
        opacity: 1 !important;
        stroke: black;
        stroke-width: 1px;
      }
    </style>

    <script>
        // Load data from a URL. You can also have the json file downloaded.
        // See https://github.com/d3/d3/blob/master/API.md#fetches-d3-fetch for more options.

        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 10, bottom: 40, left: 40},
            width = 900,
            height = 450;

        //Read the data
        d3.csv('https://raw.githubusercontent.com/fivethirtyeight/data/master/bechdel/movies.csv', d3.autoType)
          .then(function (movies) {            
            console.log("movies", movies[0]);
            years = [];
            moviesPerYear = [];
            moviesPassedPerYear =[];
            moviesPercentPassed = [];
            for (year=1973; year<=2013; year++) {
                moviesInYear = movies.filter(mov => mov.year === year);
                numMovies = moviesInYear.length;
                moviesPassedInYear = movies.filter(mov => mov.year === year && mov.binary==="PASS");
                numMoviesPassed = moviesPassedInYear.length;
                
                moviesPerYear.push(numMovies);
                moviesPassedPerYear.push(numMoviesPassed);
                moviesPercentPassed.push(numMoviesPassed/numMovies);
                movies.push(year);
            }

            const svg = d3.create('svg')
              .attr('width', width)
              .attr('height', height);
            const g = svg.append('g')
              .classed('marks', true)
              // .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Add X axis --> the years
            var x = d3.scaleLinear()
              .domain([1973, 2013])
              .range([ margin.left, width-margin.right ]);
            svg.append("g")
              .classed('x-axis', true)
              .attr("transform", "translate(0," + (height - margin.bottom) + ")")
              .call(d3.axisBottom(x).tickFormat(d3.format("d")));

            var indexToYear = d3.scaleLinear()
              .domain([0, 41])
              .range([1973, 2013])

            var brushToYear = d3.scaleLinear()
              .domain([40, 870])
              .range([1973, 2013])

            // Add Y axis
            var y = d3.scaleLinear()
              .domain([0, 1])
              .range([ height - margin.bottom, margin.top ]);
            svg.append("g")
              .classed('y-axis', true)
              .attr('transform', "translate("+(margin.left)+",0)")
              .call(d3.axisLeft(y).tickFormat(function (d) { return d*100 + "%" }));

            // Add the line
            svg.append("path")
              .datum(moviesPercentPassed)
              // .attr('transform', "translate(" + margin.left + ",0)")
              .attr("fill", "none")
              .attr("stroke", "steelblue")
              .attr("stroke-width", 1.5)
              .attr("d", d3.line()
                .x(function(d, i ) { return x(indexToYear(i)) })
                .y(function(d) { return y(d) })
              )
            
            const brush = d3.brushX()  // Add the brush feature using the d3.brush function
              .extent([[0, 0], [width, height]]) // wrong
              .extent([[margin.left, 0], [width, height - margin.bottom]])
              .on("start brush end", brushed)
            
            svg.select("g.marks")
              .attr("class", "brush")
              .call(brush)

            // 11. add brush callback to handle brush event
            function brushed(event) {
              const coords = event.selection; // [[x0, y0], [x1, y1]] for 2D brushes; [x0, x1] or [y0, y1] for 1D brushes
              if (coords) {
                // console.log(coords)
                const [x0, x1] = coords;
                console.log(x0, x1)

                // augment the data with a field "selected" which is set to true only
                // for points within the brush selection
                // const brushedData = movies.map(d => {
                //   return {
                //     selected: Math.ceil(brushToYear(x0)) <= d.year && d.year <= Math.floor(brushToYear(x1))
                //   };
                // });
                const brushedData = movies.filter(mov => mov.year >= Math.ceil(brushToYear(x0)) && mov.year <= Math.floor(brushToYear(x1)))
                console.log(brushedData)

                // chartsDataJoin(brushedData);
              }
            };

            document.getElementById("line_chart").appendChild(svg.node());
          });
    </script>
    <script>
        // for the bubble chart
        var bubble_chart_width = 520,
            bubble_chart_height = 420,
            padding = 1.5, // separation between same-color nodes
            clusterPadding = 6; // separation between different-color nodes
           
        var w = bubble_chart_width, h = bubble_chart_height;
    
        // var color = d3.scaleOrdinal(d3.schemeCategory20);
        var centerScale = d3.scalePoint().padding(1).range([0, w]);
        var forceStrength = 5;
        
        var bubble_chart_svg = d3.select("#bubble_chart").append("svg")
            .attr("width", w)
            .attr("height", h)
        
        var bubble_legend_svg = d3.select("#bubble_legend").append("svg")
            .attr("width", 320)
            .attr("height", h)

        var simulation = d3.forceSimulation()
                .force("collide",d3.forceCollide( function(d){
                    return d.r + 8 }).iterations(16) 
                )
                .force("charge", d3.forceManyBody())
                .force("y", d3.forceY().y(h / 2))
                .force("x", d3.forceX().x(w / 2))
            
        bubble_chart_svg.append("text")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "16px") 
            .text("Movies In Year");

        d3.csv('https://raw.githubusercontent.com/fivethirtyeight/data/master/bechdel/movies.csv', d3.autoType)
            .then(function(movies) {
                movies = movies.filter(mov => mov.year === 1990);

                movies.forEach(function(movie){
                    movie.r = Math.sqrt(movie.intgross*0.00001 / Math.PI);
                    movie.x = w / 2;
                    movie.y = h / 2;
                })

                function setScale(value) {
                    return Math.sqrt(value*0.00001 / Math.PI)
                }

                // Add a scale for bubble color
                function setColor(d) {
                    return d.binary =="PASS"? "#71c788" : "#b85b56";
                };

                var circles = bubble_chart_svg.selectAll("circle")
                    .data(movies, function(d){ return d.imdb ;});
                
                console.log("circles", circles);
                
                var circlesEnter = circles.enter().append("circle")
                    .attr("class", function(d) { return "bubbles " + d.binary })
                    .attr("r", function(d, i){ return d.r; })
                    .attr("cx", function(d, i){ return 175 + 25 * i + 2 * i ** 2; })
                            .attr("cy", function(d, i){ return 250; })
                    .style("fill", function(d, i){ return setColor(d) })
                    .style("stroke", function(d, i){ return setColor(d) })
                    .style("stroke-width", 1)
                    .style("pointer-events", "all")
                    .call(d3.drag()
                            .on("start", dragstarted)
                            .on("drag", dragged)
                            .on("end", dragended))
                    .on("click", clicked)
                    .on("mouseover", showTooltip )
                    .on("mousemove", moveTooltip )
                    .on("mouseleave", hideTooltip )
                
                circles = circles.merge(circlesEnter)

                let texts = bubble_chart_svg.selectAll(null)
                    .data(movies)
                    .enter()
                    .append('text')
                    .text(d => {
                        var txt = document.createElement("textarea");
                        txt.innerHTML = d.title;
                        return txt.value;
                    })
                    .attr('color', 'white')
                    .attr('font-size', 10)
                    .attr('text-anchor', 'middle')
                
                //tooltips but like for some reason none of this works
                var tooltip = d3.select("body")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "black")
                    .style("border-radius", "5px")
                    .style("padding", "10px")
                    .style("color", "white")       
                
                function showTooltip (d) {
                    tooltip
                        .transition()
                        .duration(200)
                    tooltip
                        .style("opacity", 1)
                        .html(d.title)
                        .style("left", (()=> {
                            console.log(d3.pointer(event), event);
                            // console.log((d3.pointer(event)[0]+30) + "px");
                            return (event.pageX) + "px"
                        }))
                        .style("top", (event.pageY-30) + "px")
                }

                function moveTooltip (d) {
                    tooltip
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY-30) + "px")
                }
                function hideTooltip (d) {
                    tooltip
                    .transition()
                    .duration(200)
                    .style("opacity", 0)
                }    
                

                // legend
                var valuesToShow = [10000000, 100000000, 1000000000]
                var xCircle = 100
                var xLabel = 240
                bubble_legend_svg
                    .selectAll("legend")
                    .data(valuesToShow)
                    .enter()
                    .append("circle")
                        .attr("cx", xCircle)
                        .attr("cy", function(d){ return height - 100 - setScale(d) } )
                        .attr("r", function(d){ return setScale(d) })
                        .style("fill", "none")
                        .attr("stroke", "black")

                // Add legend: segments
                bubble_legend_svg
                    .selectAll("legend")
                    .data(valuesToShow)
                    .enter()
                    .append("line")
                        .attr('x1', function(d){ return xCircle + setScale(d)} )
                        .attr('x2', xLabel)
                        .attr('y1', function(d){ return height - 100 - setScale(d) } )
                        .attr('y2', function(d){ return height - 100 - setScale(d) } )
                        .attr('stroke', 'black')
                        .style('stroke-dasharray', ('2,2'))

                // Add legend: labels
                bubble_legend_svg
                    .selectAll("legend")
                    .data(valuesToShow)
                    .enter()
                    .append("text")
                        .attr('x', xLabel)
                        .attr('y', function(d){ return height - 100 - setScale(d) } )
                        .text( function(d){ return d/1000000 } )
                        .style("font-size", 10)
                        .attr('alignment-baseline', 'middle')

                // Legend title
                bubble_legend_svg.append("text")
                    .attr('x', xCircle)
                    .attr("y", height - 100 +30)
                    .text("International Gross (M)")
                    .attr("text-anchor", "middle")

                // Add one dot in the legend for each name.
                var size = 20
                var allgroups = ["PASS", "FAIL"]
                bubble_legend_svg.selectAll("myrect")
                    .data(allgroups)
                    .enter()
                    .append("circle")
                    .attr("cx", 100)
                    .attr("cy", function(d,i){ return 100 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
                    .attr("r", 7)
                    .style("fill", function(d){
                        return d=="PASS"? "#71c788" : "#b85b56";})
                    .on("click", highlight)
                    // .on('mouseover', console.log("AHA"))
                    .on("mouseleave", noHighlight)

                // Add labels beside legend dots
                bubble_legend_svg.selectAll("mylabels")
                    .data(allgroups)
                    .enter()
                    .append("text")
                    .attr("x", 100 + size*.8)
                    .attr("y", function(d,i){ return 90 + i * (size + 5) + (size/2)}) // 100 is where the first dot appears. 25 is the distance between dots
                    .style("fill", function(d){ return d=="PASS"? "#71c788" : "#b85b56"})
                    .text(function(d){ return d})
                    .attr("text-anchor", "left")
                    .style("alignment-baseline", "middle")
                    .on("mouseover", highlight)
                    .on("mouseleave", noHighlight)

                // highlight but like also for some reason none of this works
                // What to do when one group is hovered
                function highlight (d){
                    console.log("highlight?" , d)
                    // reduce opacity of all groups
                    d3.selectAll(".bubbles").style("opacity", .05)
                    // except the one that is hovered
                    d3.selectAll("."+d.target.innerHTML).style("opacity", 1)
                }

                // And when it is not hovered anymore
                function noHighlight (d){
                    d3.selectAll(".bubbles").style("opacity", 1)
                }


                function ticked() {
                    console.log("tick")
                    //console.log(data.map(function(d){ return d.x; }));
                    circles
                        .attr("cx", function(d){ return d.x; })
                        .attr("cy", function(d){ return d.y; });
                    texts.attr('x', (data) => {
                        return data.x
                        })
                        .attr('y', (data) => {
                            return data.y
                        });
                }   

                simulation
                        .nodes(movies)
                        .on("tick", ticked);
                

                function clicked(event, d) {
                    d3.select(this).transition()
                        .attr("r", d.r * 2)
                    .transition()
                        .attr("r", d.r);
                }

                function dragstarted(mouse,node) {
                    console.log("dragstarted ", "movie", node, "d", mouse)
                    if (!mouse.active) simulation.alpha(1).restart();
                    node.fx = mouse.x;
                    node.fy = mouse.y;
                }

                function dragged(mouse,node) {
                    // console.log("dragged " + node)
                    node.fx = mouse.x;
                    node.fy = mouse.y;
                }

                function dragended(mouse,node) {
                    // console.log("dragended " + node)
                    if (!mouse.active) simulation.alphaTarget(0);
                    node.fx = null;
                    node.fy = null;
                    var me = d3.select(this)
                    console.log(me.classed("selected"))
                    me.classed("selected", !me.classed("selected"))
                    
                } 
                
                function groupBubbles() {
                    hideTitles();
                    // @v4 Reset the 'x' force to draw the bubbles to the center.
                    simulation.force('x', d3.forceX().strength(forceStrength).x(w / 2));

                    // @v4 We can reset the alpha value and restart the simulation
                    simulation.alpha(1).restart();
                }
                
                // function splitBubbles(byVar) {
                    
                //     centerScale.domain(movies.map(function(d){ return d[byVar]; }));
                    
                //     if(byVar == "all"){
                //     hideTitles()
                //     } else {
                //         showTitles(byVar, centerScale);
                //     }
                    
                //     // @v4 Reset the 'x' force to draw the bubbles to their year centers
                //     simulation.force('x', d3.forceX().strength(forceStrength).x(function(d){ 
                //         return centerScale(d[byVar]);
                //     }));

                //     // @v4 We can reset the alpha value and restart the simulation
                //     simulation.alpha(2).restart();
                // }
                
                // function hideTitles() {
                //     bubble_chart_svg.selectAll('.title').remove();
                // }

                // function showTitles(byVar, scale) {
                //     // Another way to do this would be to create
                //     // the year texts once and then just hide them.
                //     var titles = bubble_chart_svg.selectAll('.title')
                //     .data(scale.domain());
                    
                //     titles.enter().append('text')
                //         .attr('class', 'title')
                //         .merge(titles)
                //         .attr('x', function (d) { return scale(d); })
                //         .attr('y', 40)
                //         .attr('text-anchor', 'middle')
                //         .text(function (d) { return byVar + ' ' + d; });
                    
                //     titles.exit().remove() 
                // }
            }
        ).catch(e => {
            console.log(e);
        });

        Array.prototype.contains = function(v) {
            for(var i = 0; i < this.length; i++) {
                if(this[i] === v) return true;
            }
            return false;
        };

      </script>
      
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>
